import { createTRPCUntypedClient, clientCallTypeToProcedureType } from '@trpc/client';
import { createRecursiveProxy } from '@trpc/server/shared';
import { cache } from 'react';

/// <reference types="next" />
// ts-prune-ignore-next
function experimental_createTRPCNextAppDirServer(opts) {
    const getClient = cache(()=>{
        const config = opts.config();
        return createTRPCUntypedClient(config);
    });
    return createRecursiveProxy((callOpts)=>{
        // lazily initialize client
        const client = getClient();
        const pathCopy = [
            ...callOpts.path
        ];
        const procedureType = clientCallTypeToProcedureType(pathCopy.pop());
        const fullPath = pathCopy.join('.');
        return client[procedureType](fullPath, ...callOpts.args);
    });
}

export { experimental_createTRPCNextAppDirServer };
